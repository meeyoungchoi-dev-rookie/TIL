## 시스템간 강결합의 문제

- 도메인 객체에 서비스를 전달하는 경우
- 외부 서비스 성능에 직접적으로 영향을 받게 된다

## 이벤트 개요

- 이벤트가 발생한다는 것은 상태가 변경됐다는 것을 의미한다
- 이벤트가 발생하면 이벤트에 반응하여 원하는 동작을 수행하는 기능을 구현한다
- 도메인 모델에서도 도메인의 상태 변경을 이벤트로 표현할 수 있다

### 이벤트 관련 구성요소

- 도메인 모델에서 이벤트 주체는 엔티티 , 밸류 , 도메인 서비스와 같은 도메인 객체이다
- 도메인 객체는 도메인 로직을 실행해서 상태가 바뀌면 관련 이벤트를 발생시킨다

- `이벤트 핸들러`
- 이벤트 생성 주체가 발생한 이벤트에 반응한다
- 이벤트 핸들러는 생성 주체가 발생한 이벤트를 전달받아 이벤트에 담긴 데이터를 사용하여 원하는 기능을 실행한다

- `이벤트 디스패처`
- 이벤트 생성 주체와 이벤트 핸들러를 연결해 주는것
- 이벤트 생성 주체가 이벤트를 생성하여 디스패처에 이벤트를 전달한다
- 이벤트를 전달받은 디스패처는 해당 이벤트를 처리하 ㄹ수 있는 해들러에 이벤트를 전파한다
- 이벤트 디스패처의 구현 방식에 따라 이벤트 생성과 처리를 동기나 비동기로 실행하게 된다

### 이벤트의 구성

- 이벤트는 발생한 이벤트에 대한 정보를 담는다
- `이벤트 종류` - 클래스 이름으로 이벤트 종류를 포현
- `이벤트 발생 시간`
- `추가 데이터` - 주문번호, 신규 배송지 정보 등 이벤트와 관련된 정보

- 이벤트는 이벤트 핸들러가 작업을 수행하는 데 필요한 최소한의 데이터를 담아야 한다
- 데이터가 부족할 경우 핸들러는 필요한 데이터를 읽기 위해 관련 API를 호출하거나 DB에서 데이터를 직접 읽어와야 한다
- 하지만 이벤트 자체와 관련 없는 데이터를 포함할 필요는 없다

### 이벤트 용도

- `트리거`
- 도메인의 상태가 바뀔때 다른 추러리를 해야 할 경우 후처리를 실행하기 위한 트리거로 이벤트를 사용한다
- 주문의 경우 주문 취소 이벤트가 트리거가 될 수 있다
- 주문을 취소하면 환불을 처리해야 하는데 이때 환불 처리를 위한 트리거로 주문 취소 이벤트를 사용할 수 있다
- `데이터 동기화`
- 배송지를 변경하면 외부 배송 서비스에 바뀐 배송지 정보를 전송해야 한다
- 주문 도메인은 배송지 변경 이벤트를 발생시키고 이벤트 핸들러는 외부 배송 서비스와 배송지 정보를 동기화 한다

### 이벤트 장점

- 서로 다른 도메인 로직이 섞이는 것을 방지할 수 있다
- 기능 확장도 용이하다
- 기능을 확장해도 구매 도메인 로직은 수정할 필요가 없다


## 이벤트 , 핸들러, 디스패처 구현

### 이벤트 클래스

- 이벤트를 처리하는데 필요한 최소한의 데이터를 포함해야 한다
- 모든 이벤트가 공통으로 갖는 프로퍼티가 존재한다면 상위 클래스를 만들 수도 있다

### 이벤트 핸들러 인터페이스

- 이벤트 핸들러를 위한 상위 인터페이스
- EventHandler 인터페이스를 상속받는 클래스는 handle 메서드를 사용해서 필요한 기능을 구현하면 된다

### 이벤트 디스패처인 Events 구현

- 도메인을 사용하는 응용서비스는 이벤트를 받아 처리할 핸들러를 Events.handle() 로 등록한다
- 이벤트를 발생시킬 때는 Events.raise 메서드를 사용한다
- 이벤트를 처리할 핸들러를 찾아 handle 메서드를 실행한다

- Events는 핸들러 목록을 유지하기 위해 ThreadLocal 변수를 사용한다
- 톰캣과 같은 웹 애플리케이션 서버는 스레드를 재사용한다
- ThreadLocal에 보관한 값을 제거하지 않으면 기대했던 것과 다르게 코드가 동작할 수 있다
- 따라서 Events.reset 메서드를 실행해 줘야 한다

### AOP를 사용한 Events.reset 메서드 실행

- 응용 서비스가 끝나면 ThreadLocal에 등록된 핸들러 목록을 초기화 하기 위해 reset 매서드를 실행한다
- 모든 응용서비스마다 Events.reset 메서드를 넣는 것은 중복에 해당한다
- 중복을 없애기 위해 적합한 것이 AOP이다
- @Service가 붙는 클래스는 Events.reset 메서드를 명시적으로 호출하지 않아도 된다
- @Service를 사용하지 않을 경우 @Around의 포인트 컷에 execution 명시지를 사용해야 한다